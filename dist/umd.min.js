!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.FP=e()}("undefined"!=typeof self?self:this,function(){"use strict";function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function r(t,e,n){return(r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,n){var r=[null];r.push.apply(r,e);var i=new(Function.bind.apply(t,r));return n&&o(i,n.prototype),i}).apply(null,arguments)}function P(t,e){var n=this;if(!(this instanceof P))return r(P,Array.prototype.slice.call(arguments));"object"==typeof t&&(e=t).message&&(t=t.message),Error.call(this,t),"object"==typeof e&&Object.getOwnPropertyNames(e).forEach(function(t){n[t]=e[t]}),this.name=this.constructor.name,Error.captureStackTrace(this)}function w(){if(!(this instanceof w))return r(w,Array.prototype.slice.call(arguments));P.call.apply(P,[this].concat(Array.prototype.slice.call(arguments)))}var n={isPromiseLike:function(t){return!(!t||"function"!=typeof t.then)},isFunction:function(t){return"function"==typeof t},isEnumerable:function(t){return t&&Array.isArray(t)||"function"==typeof t[Symbol.iterator]},flatten:function(t){if(!Array.isArray(t))throw new Error("Method `flatten` requires valid array parameter");return t.reduce(function(t,e){return t.concat(Array.isArray(e)?n.flatten(e):[e])},[])}};var _=n.isEnumerable;var t=n.isPromiseLike;var a,i=n.isFunction,u=n.flatten,e=function(r){return{map:function(c,s,t){var f=this;if(this.steps)return this.addStep("map",Array.prototype.slice.call(arguments));1===arguments.length&&this&&this._FP&&(s=c,c=this&&this._FP&&this._FP.promise);var a=!1,p=Math.max(1,Math.min(this&&this._FP&&this._FP.concurrencyLimit||1,4)),n=this&&this._FP&&this._FP.promise?this._FP.promise:Promise.resolve(c),l=0,h=[],y=0,d=[],m=new Set,v=function(e){return function(t){return m.delete(e),d[e]=t}};return r.resolve(new Promise(function(e,i){var o=function(t){if(a)return null;a=!0,e(t)},u=function(t){if(a)return null;a=!0,i(t)};n.then(function(t){if(c=[].concat(t),!_(t))return i(new w("Invalid input data passed into FP.map()"));for(var e=function(){var e=null;return h.length>f._FP.errors.limit&&(e=u),(h.length>f._FP.errors.limit||y>=c.length||a)&&(e=o),!!e&&(Promise.all(d).then(function(t){return e(d)}),!0)},r=function(t){if(!a)return e()||d[y]||n(y),t},n=function t(n){return a?null:(y++,m.size>=p?setTimeout(function(){return t(n)},0):(d[n]||(m.add(n),d[n]=Promise.resolve(c[n]).then(function(t){return s(t,n,c)}).then(function(t){return v(n)(t)}).then(r).catch(function(t){if(f._FP.errors.count++,h.push(t),!(h.length>f._FP.errors.limit))return Promise.resolve().then(function(){return v(n)(t)}).then(r);var e=1===h.length?t:new P("Error Limit "+f._FP.errors.limit+" Exceeded.\n                idx="+n+" errCnt="+f._FP.errors.count,{errors:h,results:d,ctx:f});Promise.resolve(v(n)(t)).then(function(){return u(e)})})),d[n]))};l<p&&l<c.length;)n(l++)})}))},find:function(t){return e.call(this,t).then(function(t){var e=t.item;return e})},findIndex:function(t){return e.call(this,t).then(function(t){var e=t.index;return e})},filter:function(t,r){return this.steps?this.addStep("filter",Array.prototype.slice.call(arguments)):("function"==typeof t&&(r=t,t=this._FP.promise),n.call(this,t,function(e,n){return Promise.resolve(r(n)).then(function(t){return t?e.concat([n]):e})},[]))},flatMap:function(t,e){return this.steps?this.addStep("flatMap",Array.prototype.slice.call(arguments)):("function"==typeof t&&(e=t,t=this._FP.promise),r.resolve(t).map(e).reduce(function(t,e){return t.concat.apply(t,e)},[]))},reduce:n};function e(t,e){return this.steps?this.addStep("_find",Array.prototype.slice.call(arguments)):("function"==typeof t&&(e=t,t=this._FP.promise),r.resolve(t).filter(e).then(function(t){return null!=t[0]?{item:t[0],index:t.indexOf(t[0])}:{item:void 0,index:-1}}))}function n(t,c,e){return this.steps?this.addStep("reduce",Array.prototype.slice.call(arguments)):(t="function"==typeof t?(e=c,c=t,this._FP?this._FP.promise:this):r.resolve(t,this),new r(function(o,u){return t.then(function(t){var n=t[Symbol.iterator](),i=0;!function r(t){var e=n.next();if(e.done)return o(t);Promise.all([t,e.value]).then(function(t){var e=t[0],n=t[1];return r(c(e,n,i++))}).catch(u)}(e)})}))}}(x),c=e.map,s=e.find,f=e.findIndex,p=e.filter,l=e.flatMap,h=e.reduce,y=function(r){return{all:function(t){return r.resolve(Array.isArray(t)?Promise.all(t):(e=t,o=Object.getOwnPropertyNames(e),n=o.map(function(t){return e[t]}),Promise.all(n).then(function(t){return t.reduce(function(t,e,n){var r,i=o[n];return Object.assign(((r={})[i]=e,r),t)},{})})));var e,o,n},reject:function(t){if(t instanceof Error)return this&&(this._error=t),Promise.reject(t);throw new Error("Reject only accepts a new instance of Error!")},delay:function(t){return this.steps?this.addStep("delay",Array.prototype.slice.call(arguments)):this&&this._FP?r.resolve(this.then(e(t))):e(t)()},_delay:e};function e(n){if(!Number.isInteger(n))throw new w("FP.delay(millisec) requires a numeric arg.");return function(e){return new r(function(t){setTimeout(function(){return t(e)},n)})}}}(x),d=y.all,m=y.reject,v=y.delay,g=y._delay,F=function(o){return{tapIf:function(e,n,r){return this.steps?this.addStep("tapIf",Array.prototype.slice.call(arguments)):(1===arguments.length&&(n=e,e=function(t){return t}),t(this)?this.then(function(t){return i(e,n,r,!0)(t)}):i(e,n,r,!0))},thenIf:function(e,n,r){return this.steps?this.addStep("thenIf",Array.prototype.slice.call(arguments)):(1===arguments.length&&(n=e,e=function(t){return t}),t(this)?this.then(function(t){return i(e,n,r)(t)}):i(e,n,r))},_thenIf:i};function i(t,n,r,i){return void 0===t&&(t=function(t){return t}),void 0===n&&(n=function(t){return t}),void 0===r&&(r=function(){return null}),void 0===i&&(i=!1),function(e){return o.resolve(t(e)).then(function(t){return t?n(e):r(e)}).then(function(t){return i?e:t})}}}(x),A=F.tapIf,I=F.thenIf,E=F._thenIf,b=(a=x,{chain:function(){var t=a.resolve();return t.steps=[],t},chainEnd:function(){var f=this;return function(t){if(!f.steps||f.steps.length<=0)throw new w("No steps defined between .chain() & .chainEnd()");var e=0,n=a.unpack(),r=n.promise,i=n.resolve;for(n.reject;e<f.steps.length;){var o,u=f.steps[e],c=u[0],s=u[2];r=(o=r)[c].apply(o,s),e++}return i(t),r}}}),S=b.chain,j=b.chainEnd;function x(t){if(!(this instanceof x))return new x(t);if(1!==arguments.length)throw new Error("FunctionalPromises constructor only accepts 1 callback argument");this._FP={errors:{limit:0,count:0},promise:new Promise(t),concurrencyLimit:4}}return x.prototype.all=d,x.prototype.map=c,x.prototype.find=s,x.prototype.findIndex=f,x.prototype.filter=p,x.prototype.flatMap=l,x.prototype.reduce=h,x.prototype.listen=function(e){for(var t=this,n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];if("string"==typeof r&&(r=[r]),!e[e.addEventListener?"addEventListener":"on"])throw new w("Valid EventEmitter required.");var o=this.chainEnd();return this._FP.destroy=function(){return t._FP.destroyHandles.map(function(t){return t()||!0}).filter(function(t){return t}).length},this._FP.destroyHandles=r.map(function(t){return e[e.addEventListener?"addEventListener":"on"](t,o),function(){return e[e.removeEventListener?"removeEventListener":"off"](t,o)}}),this},x.prototype.tapIf=A,x.prototype.thenIf=I,x.prototype._thenIf=E,x.prototype.delay=v,x.prototype._delay=g,x.prototype.reject=m,x.all=x.prototype.all,x.thenIf=x.prototype._thenIf,x.delay=function(t){return x.resolve().delay(t)},x.silent=function(t){return x.resolve().silent(t)},x.chain=S,x.prototype.chainEnd=j,x.reject=x.prototype.reject,x.resolve=function(n){return new x(function(t,e){if(n&&i(n.then))return n.then(t).catch(e);t(n)})},x.promisify=function(i){var o=this;return function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return new x(function(n,r){return i.call.apply(i,[o].concat(e,[function(t,e){return t?r(t):n(e)}]))})}},x.promisifyAll=function(e){if(e&&Object.getPrototypeOf(e))return Object.getOwnPropertyNames(e).filter(function(t){return"function"==typeof e[t]}).reduce(function(t,e){return/Sync/.test(e)||t[e+"Async"]||(t[e+"Async"]=x.promisify(t[""+e])),t},e);throw new Error("Invalid Argument obj in promisifyAll(obj)")},x.unpack=function(){var n,r;return{promise:new x(function(t,e){n=t,r=e}),resolve:n,reject:r}},x.prototype.addStep=function(t,e){return this.steps&&this.steps.push([t,this,e]),this},x.prototype.concurrency=function(t){return void 0===t&&(t=1/0),this.steps?this.addStep("concurrency",Array.prototype.slice.call(arguments)):(this._FP.concurrencyLimit=t,this)},x.prototype.silent=x.prototype.quiet=function(t){return void 0===t&&(t=1/0),this.steps?this.addStep("quiet",Array.prototype.slice.call(arguments)):(this._FP.errors={count:0,limit:t},this)},x.prototype.get=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this.steps?this.addStep("get",Array.prototype.slice.call(arguments)):(e=u(e),this.then(function(n){return"object"==typeof n?1===e.length?n[e[0]]:e.reduce(function(t,e){return t[e]=n[e],t},{}):n}))},x.prototype.set=function(e,n){return this.steps?this.addStep("set",Array.prototype.slice.call(arguments)):this.then(function(t){return"object"==typeof t&&(t[e]=n),t})},x.prototype.catch=function(e){if(this.steps)return this.addStep("catch",Array.prototype.slice.call(arguments));if(2===arguments.length)return this.catchIf.apply(this,arguments);if(!i(e))throw new P("Invalid fn argument for `.catch(fn)`. Must be a function. Currently: "+typeof e);return x.resolve(this._FP.promise.catch(function(t){return e(t)}))},x.prototype.catchIf=function(e,n){if(this.steps)return this.addStep("catchIf",Array.prototype.slice.call(arguments));if(!i(n))throw new P("Invalid fn argument for `.catchIf(condition, fn)`. Must be a function. Currently: "+typeof n);return x.resolve(this._FP.promise.catch(function(t){if(e&&t instanceof e)return n(t);throw t}))},x.prototype.then=function(t){if(this.steps)return this.addStep("then",Array.prototype.slice.call(arguments));if(!i(t))throw new P("Invalid fn argument for `.then(fn)`. Must be a function. Currently: "+typeof t);return x.resolve(this._FP.promise.then(t))},x.prototype.tap=function(e){if(this.steps)return this.addStep("tap",Array.prototype.slice.call(arguments));if(!i(e))throw new P("Invalid fn argument for `.tap(fn)`. Must be a function. Currently: "+typeof e);return x.resolve(this._FP.promise.then(function(t){return e(t),t}))},x});
