"use strict";function _setPrototypeOf(t,r){return(_setPrototypeOf=Object.setPrototypeOf||function(t,r){return t.__proto__=r,t})(t,r)}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _construct(t,r,n){return(_construct=isNativeReflectConstruct()?Reflect.construct:function(t,r,n){var e=[null];e.push.apply(e,r);var i=new(Function.bind.apply(t,e));return n&&_setPrototypeOf(i,n.prototype),i}).apply(null,arguments)}function FunctionalError(t,r){var n=this;if(!(this instanceof FunctionalError))return _construct(FunctionalError,Array.prototype.slice.call(arguments));"object"==typeof t&&(r=t).message&&(t=t.message),Error.call(this,t),"object"==typeof r&&Object.getOwnPropertyNames(r).forEach(function(t){n[t]=r[t]}),this.name=this.constructor.name,Error.captureStackTrace(this)}function FPInputError(){if(!(this instanceof FPInputError))return _construct(FPInputError,Array.prototype.slice.call(arguments));FunctionalError.call.apply(FunctionalError,[this].concat(Array.prototype.slice.call(arguments)))}var utils={isPromiseLike:function(t){return!(!t||"function"!=typeof t.then)},isFunction:function(t){return"function"==typeof t},isEnumerable:function(t){return t&&Array.isArray(t)||"function"==typeof t[Symbol.iterator]},flatten:function(t){if(!Array.isArray(t))throw new Error("Method `flatten` requires valid array parameter");return t.reduce(function(t,r){return t.concat(Array.isArray(r)?utils.flatten(r):[r])},[])}};function monads(f){return{chain:function(){var t=f.resolve();return t.steps=[],t},chainEnd:function(){var a=this;return function(t){if(!a.steps||a.steps.length<=0)throw new FPInputError("No steps defined between .chain() & .chainEnd()");var r=0,n=f.unpack(),e=n.promise,i=n.resolve;for(n.reject;r<a.steps.length;){var o,s=a.steps[r],u=s[0],c=s[2];e=(o=e)[u].apply(o,c),r++}return i(t),e}}}}var isEnumerable=utils.isEnumerable;function arrays(e){return{map:function(u,c,t){var a=this;if(this.steps)return this.addStep("map",Array.prototype.slice.call(arguments));1===arguments.length&&this&&this._FP&&(c=u,u=this&&this._FP&&this._FP.promise);var f=!1,l=Math.max(1,Math.min(this&&this._FP&&this._FP.concurrencyLimit||1,4)),n=this&&this._FP&&this._FP.promise?this._FP.promise:Promise.resolve(u),p=0,h=[],y=0,d=[],P=new Set,F=function(r){return function(t){return P.delete(r),d[r]=t}};return e.resolve(new Promise(function(r,i){var o=function(t){if(f)return null;f=!0,r(t)},s=function(t){if(f)return null;f=!0,i(t)};n.then(function(t){if(u=[].concat(t),!isEnumerable(t))return i(new FPInputError("Invalid input data passed into FP.map()"));for(var r=function(){var r=null;return h.length>a._FP.errors.limit&&(r=s),(h.length>a._FP.errors.limit||y>=u.length||f)&&(r=o),!!r&&(Promise.all(d).then(function(t){return r(d)}),!0)},e=function(t){if(!f)return r()||d[y]||n(y),t},n=function t(n){return f?null:(y++,P.size>=l?setTimeout(function(){return t(n)},0):(d[n]||(P.add(n),d[n]=Promise.resolve(u[n]).then(function(t){return c(t,n,u)}).then(function(t){return F(n)(t)}).then(e).catch(function(t){if(a._FP.errors.count++,h.push(t),!(h.length>a._FP.errors.limit))return Promise.resolve().then(function(){return F(n)(t)}).then(e);var r=1===h.length?t:new FunctionalError("Error Limit "+a._FP.errors.limit+" Exceeded.\n                idx="+n+" errCnt="+a._FP.errors.count,{errors:h,results:d,ctx:a});Promise.resolve(F(n)(t)).then(function(){return s(r)})})),d[n]))};p<l&&p<u.length;)n(p++)})}))},find:function(t){return r.call(this,t).then(function(t){var r=t.item;return r})},findIndex:function(t){return r.call(this,t).then(function(t){var r=t.index;return r})},filter:function(t,e){if(this.steps)return this.addStep("filter",Array.prototype.slice.call(arguments));"function"==typeof t&&(e=t,t=this._FP.promise);return n.call(this,t,function(r,n){return Promise.resolve(e(n)).then(function(t){return t?r.concat([n]):r})},[])},flatMap:function(t,r){if(this.steps)return this.addStep("flatMap",Array.prototype.slice.call(arguments));"function"==typeof t&&(r=t,t=this._FP.promise);return e.resolve(t).map(r).reduce(function(t,r){return t.concat.apply(t,r)},[])},reduce:n};function r(t,r){return this.steps?this.addStep("_find",Array.prototype.slice.call(arguments)):("function"==typeof t&&(r=t,t=this._FP.promise),e.resolve(t).filter(r).then(function(t){return null!=t[0]?{item:t[0],index:t.indexOf(t[0])}:{item:void 0,index:-1}}))}function n(t,u,r){return this.steps?this.addStep("reduce",Array.prototype.slice.call(arguments)):(t="function"==typeof t?(r=u,u=t,this._FP?this._FP.promise:this):e.resolve(t,this),new e(function(o,s){return t.then(function(t){var n=t[Symbol.iterator](),i=0;!function e(t){var r=n.next();if(r.done)return o(t);Promise.all([t,r.value]).then(function(t){var r=t[0],n=t[1];return e(u(r,n,i++))}).catch(s)}(r)})}))}}var listen=function(r){for(var t=this,n=arguments.length,e=new Array(1<n?n-1:0),i=1;i<n;i++)e[i-1]=arguments[i];if("string"==typeof e&&(e=[e]),!r[r.addEventListener?"addEventListener":"on"])throw new FPInputError("Valid EventEmitter required.");var o=this.chainEnd();return this._FP.destroy=function(){return t._FP.destroyHandles.map(function(t){return t()||!0}).filter(function(t){return t}).length},this._FP.destroyHandles=e.map(function(t){return r[r.addEventListener?"addEventListener":"on"](t,o),function(){return r[r.removeEventListener?"removeEventListener":"off"](t,o)}}),this},isPromiseLike=utils.isPromiseLike;function conditional(o){return{tapIf:function(r,n,e){if(this.steps)return this.addStep("tapIf",Array.prototype.slice.call(arguments));1===arguments.length&&(n=r,r=function(t){return t});if(isPromiseLike(this))return this.then(function(t){return i(r,n,e,!0)(t)});return i(r,n,e,!0)},thenIf:function(r,n,e){if(this.steps)return this.addStep("thenIf",Array.prototype.slice.call(arguments));1===arguments.length&&(n=r,r=function(t){return t});if(isPromiseLike(this))return this.then(function(t){return i(r,n,e)(t)});return i(r,n,e)},_thenIf:i};function i(t,n,e,i){return void 0===t&&(t=function(t){return t}),void 0===n&&(n=function(t){return t}),void 0===e&&(e=function(){return null}),void 0===i&&(i=!1),function(r){return o.resolve(t(r)).then(function(t){return t?n(r):e(r)}).then(function(t){return i?r:t})}}}function promise(e){return{all:function(t){return e.resolve(Array.isArray(t)?Promise.all(t):(r=t,o=Object.getOwnPropertyNames(r),n=o.map(function(t){return r[t]}),Promise.all(n).then(function(t){return t.reduce(function(t,r,n){var e,i=o[n];return Object.assign(((e={})[i]=r,e),t)},{})})));var r,o,n},reject:function(t){if(t instanceof Error)return this&&(this._error=t),Promise.reject(t);throw new Error("Reject only accepts a new instance of Error!")},delay:function(t){return this.steps?this.addStep("delay",Array.prototype.slice.call(arguments)):this&&this._FP?e.resolve(this.then(r(t))):r(t)()},_delay:r};function r(n){if(!Number.isInteger(n))throw new FPInputError("FP.delay(millisec) requires a numeric arg.");return function(r){return new e(function(t){setTimeout(function(){return t(r)},n)})}}}var isFunction=utils.isFunction,flatten=utils.flatten,_arrays=arrays(FP),map=_arrays.map,find=_arrays.find,findIndex=_arrays.findIndex,filter=_arrays.filter,flatMap=_arrays.flatMap,reduce=_arrays.reduce,_promise=promise(FP),all=_promise.all,reject=_promise.reject,delay=_promise.delay,_delay=_promise._delay,_conditional=conditional(FP),tapIf=_conditional.tapIf,thenIf=_conditional.thenIf,_thenIf=_conditional._thenIf,_monads=monads(FP),chain=_monads.chain,chainEnd=_monads.chainEnd;function resolve(n){return new FP(function(t,r){if(n&&isFunction(n.then))return n.then(t).catch(r);t(n)})}function promisify(i){var o=this;return function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return new FP(function(n,e){return i.call.apply(i,[o].concat(r,[function(t,r){return t?e(t):n(r)}]))})}}function promisifyAll(r){if(!r||!Object.getPrototypeOf(r))throw new Error("Invalid Argument obj in promisifyAll(obj)");return Object.getOwnPropertyNames(r).filter(function(t){return"function"==typeof r[t]}).reduce(function(t,r){return/Sync/.test(r)||t[r+"Async"]||(t[r+"Async"]=FP.promisify(t[""+r])),t},r)}function unpack(){var n,e;return{promise:new FP(function(t,r){n=t,e=r}),resolve:n,reject:e}}function FP(t){if(!(this instanceof FP))return new FP(t);if(1!==arguments.length)throw new Error("FunctionalPromises constructor only accepts 1 callback argument");this._FP={errors:{limit:0,count:0},promise:new Promise(t),concurrencyLimit:4}}FP.prototype.all=all,FP.prototype.map=map,FP.prototype.find=find,FP.prototype.findIndex=findIndex,FP.prototype.filter=filter,FP.prototype.flatMap=flatMap,FP.prototype.reduce=reduce,FP.prototype.listen=listen,FP.prototype.tapIf=tapIf,FP.prototype.thenIf=thenIf,FP.prototype._thenIf=_thenIf,FP.prototype.delay=delay,FP.prototype._delay=_delay,FP.prototype.reject=reject,FP.all=FP.prototype.all,FP.thenIf=FP.prototype._thenIf,FP.delay=function(t){return FP.resolve().delay(t)},FP.silent=function(t){return FP.resolve().silent(t)},FP.chain=chain,FP.prototype.chainEnd=chainEnd,FP.reject=FP.prototype.reject,FP.resolve=resolve,FP.promisify=promisify,FP.promisifyAll=promisifyAll,FP.unpack=unpack,FP.prototype.addStep=function(t,r){return this.steps&&this.steps.push([t,this,r]),this},FP.prototype.concurrency=function(t){return void 0===t&&(t=1/0),this.steps?this.addStep("concurrency",Array.prototype.slice.call(arguments)):(this._FP.concurrencyLimit=t,this)},FP.prototype.quiet=function(t){return void 0===t&&(t=1/0),this.steps?this.addStep("quiet",Array.prototype.slice.call(arguments)):(this._FP.errors={count:0,limit:t},this)},FP.prototype.silent=FP.prototype.quiet,FP.prototype.get=function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return this.steps?this.addStep("get",Array.prototype.slice.call(arguments)):(r=flatten(r),this.then(function(n){return"object"==typeof n?1===r.length?n[r[0]]:r.reduce(function(t,r){return t[r]=n[r],t},{}):n}))},FP.prototype.set=function(r,n){return this.steps?this.addStep("set",Array.prototype.slice.call(arguments)):this.then(function(t){return"object"==typeof t&&(t[r]=n),t})},FP.prototype.catch=function(r){if(this.steps)return this.addStep("catch",Array.prototype.slice.call(arguments));if(2===arguments.length)return this.catchIf.apply(this,arguments);if(!isFunction(r))throw new FunctionalError("Invalid fn argument for `.catch(fn)`. Must be a function. Currently: "+typeof r);return FP.resolve(this._FP.promise.catch(function(t){return r(t)}))},FP.prototype.catchIf=function(r,n){if(this.steps)return this.addStep("catchIf",Array.prototype.slice.call(arguments));if(!isFunction(n))throw new FunctionalError("Invalid fn argument for `.catchIf(condition, fn)`. Must be a function. Currently: "+typeof n);return FP.resolve(this._FP.promise.catch(function(t){if(r&&t instanceof r)return n(t);throw t}))},FP.prototype.then=function(t){if(this.steps)return this.addStep("then",Array.prototype.slice.call(arguments));if(!isFunction(t))throw new FunctionalError("Invalid fn argument for `.then(fn)`. Must be a function. Currently: "+typeof t);return FP.resolve(this._FP.promise.then(t))},FP.prototype.tap=function(r){if(this.steps)return this.addStep("tap",Array.prototype.slice.call(arguments));if(!isFunction(r))throw new FunctionalError("Invalid fn argument for `.tap(fn)`. Must be a function. Currently: "+typeof r);return FP.resolve(this._FP.promise.then(function(t){return r(t),t}))},module.exports=FP;
