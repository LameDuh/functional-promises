"use strict";function _inheritsLoose(t,r){t.prototype=Object.create(r.prototype),(t.prototype.constructor=t).__proto__=r}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _setPrototypeOf(t,r){return(_setPrototypeOf=Object.setPrototypeOf||function(t,r){return t.__proto__=r,t})(t,r)}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _construct(t,r,e){return(_construct=isNativeReflectConstruct()?Reflect.construct:function(t,r,e){var n=[null];n.push.apply(n,r);var i=new(Function.bind.apply(t,n));return e&&_setPrototypeOf(i,e.prototype),i}).apply(null,arguments)}function _isNativeFunction(t){return-1!==Function.toString.call(t).indexOf("[native code]")}function _wrapNativeSuper(t){var e="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(t){if(null===t||!_isNativeFunction(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,r)}function r(){return _construct(t,arguments,_getPrototypeOf(this).constructor)}return r.prototype=Object.create(t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(r,t)})(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var FunctionalError=function(n){function t(t,r){var e;return"object"==typeof t&&(r=t).message&&(t=t.message),e=n.call(this,t)||this,"object"==typeof r&&Object.getOwnPropertyNames(r).forEach(function(t){e[t]=r[t]}),e.name=e.constructor.name,Error.captureStackTrace(_assertThisInitialized(_assertThisInitialized(e)),e.constructor),e}return _inheritsLoose(t,n),t}(_wrapNativeSuper(Error)),FunctionalUserError=function(t){function r(){return t.apply(this,arguments)||this}return _inheritsLoose(r,t),r}(FunctionalError),FPUnexpectedError=function(t){function r(){return t.apply(this,arguments)||this}return _inheritsLoose(r,t),r}(FunctionalError),FPInputError=function(t){function r(){return t.apply(this,arguments)||this}return _inheritsLoose(r,t),r}(FunctionalError),FPSoftError=function(t){function r(){return t.apply(this,arguments)||this}return _inheritsLoose(r,t),r}(FunctionalError),FPTimeout=function(t){function r(){return t.apply(this,arguments)||this}return _inheritsLoose(r,t),r}(FunctionalError),utils={isPromiseLike:function(t){return!(!t||"function"!=typeof t.then)},isFunction:function(t){return"function"==typeof t},isEnumerable:function(t){return t&&Array.isArray(t)||"function"==typeof t[Symbol.iterator]},flatten:function(t){if(!Array.isArray(t))throw new Error("Method `flatten` requires valid array parameter");return t.reduce(function(t,r){return t.concat(Array.isArray(r)?utils.flatten(r):[r])},[])}};function monads(f){return{chain:function(){var t=f.resolve();return t.steps=[],t},chainEnd:function(){var a=this;return function(t){if(!a.steps||a.steps.length<=0)throw new FPInputError("No steps defined between .chain() & .chainEnd()");var r=0,e=f.unpack(),n=e.promise,i=e.resolve;for(e.reject;r<a.steps.length;){var o,u=a.steps[r],s=u[0],c=u[2];n=(o=n)[s].apply(o,c),r++}return i(t),n}}}}var isEnumerable=utils.isEnumerable;function arrays(n){return{map:function(s,c,t){var a=this;if(this.steps)return this.addStep("map",Array.prototype.slice.call(arguments));1===arguments.length&&this&&this._FP&&(c=s,s=this&&this._FP&&this._FP.promise);var f=!1,p=Math.max(1,Math.min(this&&this._FP&&this._FP.concurrencyLimit||1,4)),e=this&&this._FP&&this._FP.promise?this._FP.promise:Promise.resolve(s),l=0,h=[],y=0,d=[],P=new Set,F=function(r){return function(t){return P.delete(r),d[r]=t}};return n.resolve(new Promise(function(r,i){var o=function(t){if(f)return null;f=!0,r(t)},u=function(t){if(f)return null;f=!0,i(t)};e.then(function(t){if(s=[].concat(t),!isEnumerable(t))return i(new FPInputError("Invalid input data passed into FP.map()"));for(var r=function(){var r=null;return h.length>a._FP.errors.limit&&(r=u),(h.length>a._FP.errors.limit||y>=s.length||f)&&(r=o),!!r&&(Promise.all(d).then(function(t){return r(d)}),!0)},n=function(t){if(!f)return r()||d[y]||e(y),t},e=function t(e){return f?null:(y++,P.size>=p?setTimeout(function(){return t(e)},0):(d[e]||(P.add(e),d[e]=Promise.resolve(s[e]).then(function(t){return c(t,e,s)}).then(function(t){return F(e)(t)}).then(n).catch(function(t){if(a._FP.errors.count++,h.push(t),!(h.length>a._FP.errors.limit))return Promise.resolve().then(function(){return F(e)(t)}).then(n);var r=1===h.length?t:new FunctionalError("Error Limit "+a._FP.errors.limit+" Exceeded.\n                idx="+e+" errCnt="+a._FP.errors.count,{errors:h,results:d,ctx:a});Promise.resolve(F(e)(t)).then(function(){return u(r)})})),d[e]))};l<p&&l<s.length;)e(l++)})}))},find:function(t){return r.call(this,t).then(function(t){var r=t.item;return r})},findIndex:function(t){return r.call(this,t).then(function(t){var r=t.index;return r})},filter:function(t,n){if(this.steps)return this.addStep("filter",Array.prototype.slice.call(arguments));"function"==typeof t&&(n=t,t=this._FP.promise);return e.call(this,t,function(r,e){return Promise.resolve(n(e)).then(function(t){return t?r.concat([e]):r})},[])},flatMap:function(t,r){if(this.steps)return this.addStep("flatMap",Array.prototype.slice.call(arguments));"function"==typeof t&&(r=t,t=this._FP.promise);return n.resolve(t).map(r).reduce(function(t,r){return t.concat.apply(t,r)},[])},reduce:e};function r(t,r){return this.steps?this.addStep("_find",Array.prototype.slice.call(arguments)):("function"==typeof t&&(r=t,t=this._FP.promise),n.resolve(t).filter(r).then(function(t){return null!=t[0]?{item:t[0],index:t.indexOf(t[0])}:{item:void 0,index:-1}}))}function e(t,s,r){return this.steps?this.addStep("reduce",Array.prototype.slice.call(arguments)):(t="function"==typeof t?(r=s,s=t,this._FP?this._FP.promise:this):n.resolve(t,this),new n(function(o,u){return t.then(function(t){var e=t[Symbol.iterator](),i=0;!function n(t){var r=e.next();if(r.done)return o(t);Promise.all([t,r.value]).then(function(t){var r=t[0],e=t[1];return n(s(r,e,i++))}).catch(u)}(r)})}))}}var listen=function(r){for(var t=this,e=arguments.length,n=new Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];if("string"==typeof n&&(n=[n]),!r[r.addEventListener?"addEventListener":"on"])throw new FPInputError("Valid EventEmitter required.");var o=this.chainEnd();return this._FP.destroy=function(){return t._FP.destroyHandles.map(function(t){return t()||!0}).filter(function(t){return t}).length},this._FP.destroyHandles=n.map(function(t){return r[r.addEventListener?"addEventListener":"on"](t,o),function(){return r[r.removeEventListener?"removeEventListener":"off"](t,o)}}),this},isPromiseLike=utils.isPromiseLike;function conditional(o){return{tapIf:function(r,e,n){if(this.steps)return this.addStep("tapIf",Array.prototype.slice.call(arguments));1===arguments.length&&(e=r,r=function(t){return t});if(isPromiseLike(this))return this.then(function(t){return i(r,e,n,!0)(t)});return i(r,e,n,!0)},thenIf:function(r,e,n){if(this.steps)return this.addStep("thenIf",Array.prototype.slice.call(arguments));1===arguments.length&&(e=r,r=function(t){return t});if(isPromiseLike(this))return this.then(function(t){return i(r,e,n)(t)});return i(r,e,n)},_thenIf:i};function i(t,e,n,i){return void 0===t&&(t=function(t){return t}),void 0===e&&(e=function(t){return t}),void 0===n&&(n=function(){return null}),void 0===i&&(i=!1),function(r){return o.resolve(t(r)).then(function(t){return t?e(r):n(r)}).then(function(t){return i?r:t})}}}function promise(n){return{all:function(t){return n.resolve(Array.isArray(t)?Promise.all(t):(r=t,o=Object.getOwnPropertyNames(r),e=o.map(function(t){return r[t]}),Promise.all(e).then(function(t){return t.reduce(function(t,r,e){var n,i=o[e];return Object.assign(((n={})[i]=r,n),t)},{})})));var r,o,e},reject:function(t){if(t instanceof Error)return this&&(this._error=t),Promise.reject(t);throw new Error("Reject only accepts a new instance of Error!")},delay:function(t){return this.steps?this.addStep("delay",Array.prototype.slice.call(arguments)):this&&this._FP?n.resolve(this.then(r(t))):r(t)()},_delay:r};function r(e){if(!Number.isInteger(e))throw new FPInputError("FP.delay(millisec) requires a numeric arg.");return function(r){return new n(function(t){setTimeout(function(){return t(r)},e)})}}}var isFunction=utils.isFunction,flatten=utils.flatten,_arrays=arrays(FP),map=_arrays.map,find=_arrays.find,findIndex=_arrays.findIndex,filter=_arrays.filter,flatMap=_arrays.flatMap,reduce=_arrays.reduce,_promise=promise(FP),all=_promise.all,reject=_promise.reject,delay=_promise.delay,_delay=_promise._delay,_conditional=conditional(FP),tapIf=_conditional.tapIf,thenIf=_conditional.thenIf,_thenIf=_conditional._thenIf,_monads=monads(FP),chain=_monads.chain,chainEnd=_monads.chainEnd;function resolve(e){return new FP(function(t,r){if(e&&isFunction(e.then))return e.then(t).catch(r);t(e)})}function promisify(i){var o=this;return function(){for(var t=arguments.length,r=new Array(t),e=0;e<t;e++)r[e]=arguments[e];return new FP(function(e,n){return i.call.apply(i,[o].concat(r,[function(t,r){return t?n(t):e(r)}]))})}}function promisifyAll(r){if(!r||!Object.getPrototypeOf(r))throw new Error("Invalid Argument obj in promisifyAll(obj)");return Object.getOwnPropertyNames(r).filter(function(t){return"function"==typeof r[t]}).reduce(function(t,r){return/Sync/.test(r)||t[r+"Async"]||(t[r+"Async"]=FP.promisify(t[""+r])),t},r)}function unpack(){var e,n;return{promise:new FP(function(t,r){e=t,n=r}),resolve:e,reject:n}}function FP(t){if(!(this instanceof FP))return new FP(t);if(1!==arguments.length)throw new Error("FunctionalPromises constructor only accepts 1 callback argument");this._FP={errors:{limit:0,count:0},promise:new Promise(t),concurrencyLimit:4}}FP.prototype.all=all,FP.prototype.map=map,FP.prototype.find=find,FP.prototype.findIndex=findIndex,FP.prototype.filter=filter,FP.prototype.flatMap=flatMap,FP.prototype.reduce=reduce,FP.prototype.listen=listen,FP.prototype.tapIf=tapIf,FP.prototype.thenIf=thenIf,FP.prototype._thenIf=_thenIf,FP.prototype.delay=delay,FP.prototype._delay=_delay,FP.prototype.reject=reject,FP.all=FP.prototype.all,FP.thenIf=FP.prototype._thenIf,FP.delay=function(t){return FP.resolve().delay(t)},FP.silent=function(t){return FP.resolve().silent(t)},FP.chain=chain,FP.prototype.chainEnd=chainEnd,FP.reject=FP.prototype.reject,FP.resolve=resolve,FP.promisify=promisify,FP.promisifyAll=promisifyAll,FP.unpack=unpack,FP.prototype.addStep=function(t,r){return this.steps&&this.steps.push([t,this,r]),this},FP.prototype.concurrency=function(t){return void 0===t&&(t=1/0),this.steps?this.addStep("concurrency",Array.prototype.slice.call(arguments)):(this._FP.concurrencyLimit=t,this)},FP.prototype.quiet=function(t){return void 0===t&&(t=1/0),this.steps?this.addStep("quiet",Array.prototype.slice.call(arguments)):(this._FP.errors={count:0,limit:t},this)},FP.prototype.silent=FP.prototype.quiet,FP.prototype.get=function(){for(var t=arguments.length,r=new Array(t),e=0;e<t;e++)r[e]=arguments[e];return this.steps?this.addStep("get",Array.prototype.slice.call(arguments)):(r=flatten(r),this.then(function(e){return"object"==typeof e?1===r.length?e[r[0]]:r.reduce(function(t,r){return t[r]=e[r],t},{}):e}))},FP.prototype.set=function(r,e){return this.steps?this.addStep("set",Array.prototype.slice.call(arguments)):this.then(function(t){return"object"==typeof t&&(t[r]=e),t})},FP.prototype.catch=function(r){if(this.steps)return this.addStep("catch",Array.prototype.slice.call(arguments));if(2===arguments.length)return this.catchIf.apply(this,arguments);if(!isFunction(r))throw new FunctionalError("Invalid fn argument for `.catch(fn)`. Must be a function. Currently: "+typeof r);return FP.resolve(this._FP.promise.catch(function(t){return r(t)}))},FP.prototype.catchIf=function(r,e){if(this.steps)return this.addStep("catchIf",Array.prototype.slice.call(arguments));if(!isFunction(e))throw new FunctionalError("Invalid fn argument for `.catchIf(condition, fn)`. Must be a function. Currently: "+typeof e);return FP.resolve(this._FP.promise.catch(function(t){if(r&&t instanceof r)return e(t);throw t}))},FP.prototype.then=function(t){if(this.steps)return this.addStep("then",Array.prototype.slice.call(arguments));if(!isFunction(t))throw new FunctionalError("Invalid fn argument for `.then(fn)`. Must be a function. Currently: "+typeof t);return FP.resolve(this._FP.promise.then(t))},FP.prototype.tap=function(r){if(this.steps)return this.addStep("tap",Array.prototype.slice.call(arguments));if(!isFunction(r))throw new FunctionalError("Invalid fn argument for `.tap(fn)`. Must be a function. Currently: "+typeof r);return FP.resolve(this._FP.promise.then(function(t){return r(t),t}))},module.exports=FP;
